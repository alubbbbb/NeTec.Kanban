@*
  Das Model wurde exakt auf dein Projekt angepasst.
  Namespace: NeTec.Kanban.Domain.Entities
  Model: Board
*@
@model NeTec.Kanban.Domain.Entities.Board
@{
    ViewData["Title"] = $"Kanban Board: {Model.Titel}";
}

@* Spezifische Stile für das Kanban-Board und die neuen Formulare. *@
<style>
    .kanban-board-container {
        display: flex;
        overflow-x: auto;
        gap: 1.25rem;
        min-height: 75vh;
        padding-bottom: 1rem;
    }

    .kanban-column {
        flex: 0 0 320px;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        max-height: 75vh;
        display: flex;
        flex-direction: column;
    }

    .column-header {
        padding: 0.75rem 1rem;
        font-weight: 600;
        border-bottom: 1px solid #dee2e6;
    }

    .task-list {
        min-height: 100px;
        overflow-y: auto;
        flex-grow: 1;
        padding: 0.5rem;
    }

    .task-card {
        cursor: grab;
        margin-bottom: 0.5rem;
    }

        .task-card:active {
            cursor: grabbing;
        }

    .sortable-ghost {
        opacity: 0.4;
        background: #cce5ff;
    }

    /* NEU: Stile für den "Aufgabe hinzufügen"-Bereich */
    .column-footer {
        padding: 0.5rem;
    }

    .add-task-form textarea {
        resize: vertical;
    }
</style>

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">@Model.Titel</h1>
        <a asp-action="Index" asp-controller="Home" class="btn btn-sm btn-outline-secondary">Zurück zur Übersicht</a>
    </div>

    <div class="kanban-board-container">
        @if (Model.Columns != null && Model.Columns.Any())
        {
            @foreach (var column in Model.Columns.OrderBy(c => c.OrderIndex))
            {
                <div class="kanban-column">
                    <div class="column-header text-uppercase small">
                        @column.Titel <span class="badge bg-secondary rounded-pill column-task-count">@column.Tasks.Count</span>
                    </div>

                    <div class="task-list" data-column-id="@column.Id">
                        @if (column.Tasks != null)
                        {
                            @foreach (var task in column.Tasks.OrderBy(t => t.OrderIndex))
                            {
                                <partial name="_TaskCardPartial" model="task" />
                            }
                        }
                    </div>

                    <!-- NEU: Bereich zum Hinzufügen neuer Aufgaben -->
                    <div class="column-footer">
                        <form class="add-task-form d-none" data-column-id="@column.Id">
                            <textarea class="form-control form-control-sm mb-2" rows="3" placeholder="Aufgabentitel eingeben..." required></textarea>
                            <button type="submit" class="btn btn-primary btn-sm">Speichern</button>
                            <button type="button" class="btn btn-link btn-sm text-secondary cancel-add-task">Abbrechen</button>
                        </form>
                        <button class="btn btn-sm btn-light w-100 text-start show-add-task-form">
                            <i class="bi bi-plus"></i> Aufgabe hinzufügen
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

@* NEU: Ich habe die Task-Karte in eine Partial View ausgelagert, um sie im JavaScript wiederverwenden zu können. *@
@* Erstelle eine Datei _TaskCardPartial.cshtml im selben Ordner oder in /Views/Shared/ *@
@*
   Inhalt für _TaskCardPartial.cshtml:

   @model NeTec.Kanban.Domain.Entities.Task

   <article class="card task-card" data-task-id="@Model.Id">
       <div class="card-body p-3">
           <h5 class="card-title fs-6 mb-2">@Model.Title</h5>
           <p class="card-text small text-muted">@Model.Description</p>
           @if (!string.IsNullOrEmpty(Model.Priority))
           {
               var priorityClass = Model.Priority switch {
                   "High" => "bg-danger", "Medium" => "bg-warning text-dark", "Low" => "bg-success", _ => "bg-secondary"
               };
               <span class="badge @priorityClass">@Model.Priority</span>
           }
       </div>
   </article>
*@


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // Initialisiert Drag-and-Drop für alle Spalten
            initializeSortable();

            // Initialisiert die Buttons und Formulare zum Erstellen von Aufgaben
            initializeTaskCreation();

            function initializeSortable() {
                document.querySelectorAll('.task-list').forEach(column => {
                    new Sortable(column, {
                        group: 'kanban-tasks',
                        animation: 150,
                        handle: '.task-card',
                        onEnd: function (evt) {
                            const taskId = evt.item.dataset.taskId;
                            const newColumnId = evt.to.dataset.columnId;
                            updateTaskColumn(taskId, newColumnId);
                        }
                    });
                });
            }

            function initializeTaskCreation() {
                // Event-Handler für "Aufgabe hinzufügen"-Buttons
                document.querySelectorAll('.show-add-task-form').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.classList.add('d-none');
                        btn.closest('.column-footer').querySelector('.add-task-form').classList.remove('d-none');
                    });
                });

                // Event-Handler für "Abbrechen"-Buttons
                document.querySelectorAll('.cancel-add-task').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const footer = btn.closest('.column-footer');
                        footer.querySelector('.add-task-form').classList.add('d-none');
                        footer.querySelector('.show-add-task-form').classList.remove('d-none');
                        footer.querySelector('textarea').value = ''; // Textarea leeren
                    });
                });

                // Event-Handler für das Absenden des Formulars
                document.querySelectorAll('.add-task-form').forEach(form => {
                    form.addEventListener('submit', function (event) {
                        event.preventDefault();
                        const textarea = form.querySelector('textarea');
                        const title = textarea.value.trim();
                        const columnId = form.dataset.columnId;

                        if (title) {
                            createTask(title, columnId, form);
                        }
                    });
                });
            }

            /**
             * Sendet die Aktualisierung für eine verschobene Aufgabe per AJAX.
             */
            function updateTaskColumn(taskId, newColumnId) {
                fetch('/Task/UpdateColumn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId: parseInt(taskId), newColumnId: parseInt(newColumnId) })
                })
                .then(response => {
                    if (!response.ok) {
                        alert('Änderung konnte nicht gespeichert werden.');
                        location.reload();
                    }
                });
            }

            /**
             * Erstellt eine neue Aufgabe per AJAX.
             */
            function createTask(title, columnId, form) {
                fetch('/Task/Create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title, columnId: parseInt(columnId) })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server-Antwort war nicht erfolgreich.');
                    }
                    return response.json();
                })
                .then(newTask => {
                    // Neue Aufgabe erfolgreich erstellt, jetzt die UI aktualisieren.
                    const taskList = document.querySelector(`.task-list[data-column-id="${columnId}"]`);
                    const newTaskCard = createTaskCardElement(newTask);
                    taskList.appendChild(newTaskCard);

                    // Aufgaben-Zähler in der Spalte aktualisieren
                    const countElement = taskList.closest('.kanban-column').querySelector('.column-task-count');
                    countElement.textContent = parseInt(countElement.textContent) + 1;

                    // Formular zurücksetzen
                    form.querySelector('.cancel-add-task').click();
                })
                .catch(error => {
                    console.error('Fehler beim Erstellen der Aufgabe:', error);
                    alert('Die Aufgabe konnte nicht erstellt werden.');
                });
            }

            /**
             * Erstellt ein HTML-Element für eine neue Aufgabenkarte.
             * Dies vermeidet, HTML-Strings manuell zusammenzubauen.
             */
            function createTaskCardElement(task) {
                const article = document.createElement('article');
                article.className = 'card task-card';
                article.dataset.taskId = task.id;

                // Hier könntest du die Partial View per AJAX nachladen oder den HTML-String manuell bauen.
                // Ein manueller Build ist für einfache Karten performanter.
                let priorityHtml = '';
                if (task.priority) {
                    const priorityClass = task.priority === 'High' ? 'bg-danger' : task.priority === 'Medium' ? 'bg-warning text-dark' : 'bg-success';
                    priorityHtml = `<span class="badge ${priorityClass}">${task.priority}</span>`;
                }

                article.innerHTML = `
                    <div class="card-body p-3">
                        <h5 class="card-title fs-6 mb-2">${task.title}</h5>
                        <p class="card-text small text-muted">${task.description || ''}</p>
                        ${priorityHtml}
                    </div>`;
                return article;
            }
        });
    </script>
}