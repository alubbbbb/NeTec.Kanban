@model NeTec.Kanban.Domain.Entities.Board
@{
    ViewData["Title"] = $"Kanban Board: {Model.Titel}";
}

<div class="container-fluid py-4">
    @Html.AntiForgeryToken()

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center kanban-header">
        <h1 class="board-title">@Model.Titel</h1>
        <div>
            <button class="btn btn-primary me-2" id="showAddColumnForm">
                <i class="bi bi-plus-lg"></i> Neue Spalte
            </button>
            <a asp-action="Index" asp-controller="Board" class="btn btn-outline-secondary">
                ← Zurück zur Übersicht
            </a>
        </div>
    </div>

    <!-- Spalte anlegen -->
    <div id="addColumnForm" class="d-none mb-3">
        <div class="card" style="max-width: 400px;">
            <div class="card-body">
                <h6 class="card-title">Neue Spalte erstellen</h6>
                <form id="createColumnForm">
                    <div class="mb-3">
                        <label for="newColumnTitle" class="form-label">Spalten-Name</label>
                        <input type="text" id="newColumnTitle" class="form-control" maxlength="100" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                    <button type="button" class="btn btn-link btn-sm" id="cancelAddColumn">Abbrechen</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Kanban Columns -->
    <div class="kanban-columns">
        @foreach (var column in Model.Columns.OrderBy(c => c.OrderIndex))
        {
            <div class="column" data-column-id="@column.Id">

                <div class="column-title">
                    @column.Titel
                    <span class="badge bg-secondary rounded-pill ms-2">
                        @(column.Tasks?.Count ?? 0)
                    </span>
                </div>

                <div class="task-list" data-column-id="@column.Id">
                    @foreach (var task in column.Tasks.OrderBy(t => t.OrderIndex))
                    {
                        var priorityClass = task.Priority switch
                        {
                            "High" => "bg-danger",
                            "Medium" => "bg-warning text-dark",
                            "Low" => "bg-success",
                            _ => "bg-secondary"
                        };

                        <div class="card task-card mb-2" data-task-id="@task.Id">
                            <div class="card-body p-2">

                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h5 class="card-title fs-6 mb-0">@task.Title</h5>

                                    <button class="btn btn-sm btn-outline-primary btn-edit-task"
                                            data-task-id="@task.Id">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>

                                @if (!string.IsNullOrEmpty(task.Description))
                                {
                                    <p class="card-text small text-muted mb-1">@task.Description</p>
                                }

                                <span class="badge @priorityClass">@task.Priority</span>
                            </div>
                        </div>
                    }
                </div>

                <div class="column-footer p-2 text-center">
                    <button class="btn btn-sm btn-secondary btn-add-task"
                            data-column-id="@column.Id">
                        <i class="bi bi-plus"></i> Aufgabe hinzufügen
                    </button>
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Aufgabe</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="editTaskId">
                <input type="hidden" id="editTaskColumnId">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Titel *</label>
                        <input id="editTaskTitle" class="form-control" maxlength="100" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Priorität</label>
                        <select id="editTaskPriority" class="form-select">
                            <option value="Low">Niedrig</option>
                            <option value="Medium" selected>Mittel</option>
                            <option value="High">Hoch</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Beschreibung</label>
                    <textarea id="editTaskDescription" class="form-control" rows="3"></textarea>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Fällig bis</label>
                        <input type="date" id="editTaskDueDate" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Geplante Stunden</label>
                        <input type="number" step="0.1" id="editTaskPlannedTime" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Verbleibende Stunden</label>
                        <input type="number" step="0.1" id="editTaskActualTime" class="form-control">
                    </div>
                </div>

                <div class="mb-3">
                    <label>Zuständig</label>
                    <select id="editTaskAssignedUser" class="form-select">
                        <option value="">Nicht zugewiesen</option>
                    </select>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button class="btn btn-primary" id="saveTaskChanges">Speichern</button>
            </div>

        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            initializeSortable();
            initializeTaskEditing();
            initializeColumnCreation();
            initializeTaskCreation();
            loadAssignableUsers();
            hookPlannedHoursAutoFill();

            // -----------------------------------------
            // BENUTZER LADEN
            // -----------------------------------------
            function loadAssignableUsers() {
                fetch('/Task/GetAssignableUsers')
                    .then(r => r.json())
                    .then(users => {
                        const select = document.getElementById("editTaskAssignedUser");

                        users.forEach(u => {
                            const option = document.createElement("option");
                            option.value = u.id;
                            option.textContent = u.userName;
                            select.appendChild(option);
                        });
                    });
            }

            // -----------------------------------------
            // Geplante Stunden -> Verbleibende Stunden
            // -----------------------------------------
            function hookPlannedHoursAutoFill() {
                document.getElementById("editTaskPlannedTime")
                    .addEventListener("input", () => {
                        const planned = parseFloat(document.getElementById("editTaskPlannedTime").value);
                        if (!isNaN(planned)) {
                            document.getElementById("editTaskActualTime").value = planned;
                        }
                    });
            }

            // -----------------------------------------
            // Drag & Drop
            // -----------------------------------------
            function initializeSortable() {
                document.querySelectorAll(".task-list").forEach(list => {
                    new Sortable(list, {
                        group: "kanban-tasks",
                        animation: 150,
                        ghostClass: "sortable-ghost",
                        onEnd: evt => {
                            const taskId = evt.item.dataset.taskId;
                            const newColumnId = evt.to.dataset.columnId;
                            const newOrderIndex = Array.from(evt.to.children).indexOf(evt.item);
                            updateTaskColumn(taskId, newColumnId, newOrderIndex);
                            updateColumnCounters();
                        }
                    });
                });
            }

            function updateColumnCounters() {
                document.querySelectorAll(".column").forEach(col => {
                    const count = col.querySelectorAll(".task-card").length;
                    const badge = col.querySelector(".badge.rounded-pill");
                    if (badge) badge.textContent = count;
                });
            }

            function updateTaskColumn(taskId, columnId, newIndex) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                fetch('@Url.Action("UpdateTaskColumn", "Task")', {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "RequestVerificationToken": token },
                    body: JSON.stringify({
                        taskId: parseInt(taskId),
                        newColumnId: parseInt(columnId),
                        newOrderIndex: newIndex
                    })
                }).catch(() => toastr.error("Fehler beim Verschieben"));
            }

            // -----------------------------------------
            // Aufgabe hinzufügen
            // -----------------------------------------
            function initializeTaskCreation() {
                document.querySelectorAll(".btn-add-task").forEach(btn => {
                    btn.addEventListener("click", () => {

                        const columnId = btn.dataset.columnId;

                        document.getElementById("editTaskId").value = "";
                        document.getElementById("editTaskColumnId").value = columnId;

                        document.getElementById("editTaskTitle").value = "";
                        document.getElementById("editTaskDescription").value = "";
                        document.getElementById("editTaskPriority").value = "Medium";
                        document.getElementById("editTaskDueDate").value = "";
                        document.getElementById("editTaskPlannedTime").value = "";
                        document.getElementById("editTaskActualTime").value = "";
                        document.getElementById("editTaskAssignedUser").value = "";

                        new bootstrap.Modal(document.getElementById("editTaskModal")).show();
                    });
                });
            }

            // -----------------------------------------
            // Aufgabe bearbeiten
            // -----------------------------------------
            function initializeTaskEditing() {
                document.querySelectorAll(".btn-edit-task").forEach(btn => {
                    btn.addEventListener("click", () => {

                        const id = btn.dataset.taskId;

                        fetch('@Url.Action("GetTask", "Task")/' + id)
                            .then(r => r.json())
                            .then(data => {

                                document.getElementById("editTaskId").value = data.id;
                                document.getElementById("editTaskColumnId").value = data.columnId;
                                document.getElementById("editTaskTitle").value = data.title;
                                document.getElementById("editTaskDescription").value = data.description ?? "";
                                document.getElementById("editTaskPriority").value = data.priority ?? "Medium";
                                document.getElementById("editTaskDueDate").value = data.dueDate ?? "";
                                document.getElementById("editTaskPlannedTime").value = data.plannedTime ?? "";
                                document.getElementById("editTaskActualTime").value = data.actualTime ?? "";
                                document.getElementById("editTaskAssignedUser").value = data.assignedUserId ?? "";

                                new bootstrap.Modal(document.getElementById("editTaskModal")).show();
                            })
                            .catch(() => toastr.error("Fehler beim Laden"));
                    });
                });

                document.getElementById("saveTaskChanges").addEventListener("click", () => {

                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    const id = document.getElementById("editTaskId").value;

                    const payload = {
                        id: id ? parseInt(id) : null,
                        columnId: parseInt(document.getElementById("editTaskColumnId").value),
                        title: document.getElementById("editTaskTitle").value.trim(),
                        description: document.getElementById("editTaskDescription").value.trim() || null,
                        priority: document.getElementById("editTaskPriority").value,
                        dueDate: document.getElementById("editTaskDueDate").value || null,
                        plannedTime: parseFloat(document.getElementById("editTaskPlannedTime").value) || null,
                        actualTime: parseFloat(document.getElementById("editTaskActualTime").value) || null,
                        assignedUserId: document.getElementById("editTaskAssignedUser").value || null
                    };

                    if (!payload.title) {
                        toastr.warning("Titel ist erforderlich.");
                        return;
                    }

                    const endpoint = id
                        ? '@Url.Action("EditTask", "Task")'
                        : '@Url.Action("Create", "Task")';

                    fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "RequestVerificationToken": token },
                        body: JSON.stringify(payload)
                    })
                    .then(r => {
                        if (!r.ok) throw 0;
                        toastr.success("Gespeichert");
                        location.reload();
                    })
                    .catch(() => toastr.error("Fehler beim Speichern"));
                });
            }

            // -----------------------------------------
            // Spalten erstellen
            // -----------------------------------------
            function initializeColumnCreation() {

                const showBtn = document.getElementById("showAddColumnForm");
                const cancelBtn = document.getElementById("cancelAddColumn");
                const form = document.getElementById("createColumnForm");

                showBtn.addEventListener("click", () => {
                    showBtn.classList.add("d-none");
                    document.getElementById("addColumnForm").classList.remove("d-none");
                    document.getElementById("newColumnTitle").focus();
                });

                cancelBtn.addEventListener("click", () => {
                    document.getElementById("addColumnForm").classList.add("d-none");
                    showBtn.classList.remove("d-none");
                    document.getElementById("newColumnTitle").value = "";
                });

                form.addEventListener("submit", evt => {
                    evt.preventDefault();

                    const title = document.getElementById("newColumnTitle").value.trim();
                    if (!title) return;

                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    const formData = new FormData();

                    formData.append("boardId", @Model.Id);
                    formData.append("title", title);
                    formData.append("__RequestVerificationToken", token);

                    fetch('@Url.Action("CreateColumn", "Board")', {
                        method: "POST",
                        body: formData
                    })
                    .then(r => r.ok ? location.reload() : toastr.error("Fehler"))
                    .catch(() => toastr.error("Fehler beim Erstellen"));
                });
            }

        });
    </script>
}
