@model IEnumerable<NeTec.Kanban.Domain.Entities.Board>
@{
    ViewData["Title"] = "Alle Boards";
}

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Lokale Styles für diese Seite -->
<style>
    .table-hover > tbody > tr:hover {
        background-color: #fff8e1;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
</style>

<div class="container-fluid py-3">
    <!-- Header-Sektion -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Alle Boards</h2>
        <div class="d-flex gap-2">
            <form asp-action="Search" method="get" class="d-flex gap-2">
                <input type="text" name="q" value="@ViewData["SearchQuery"]" class="form-control" placeholder="Board suchen...">
                <button type="submit" class="btn btn-secondary"><i class="bi bi-search"></i></button>
            </form>
            <button class="btn btn-primary fw-bold" data-bs-toggle="modal" data-bs-target="#createBoardModal">
                <i class="bi bi-plus-lg me-2"></i>Board erstellen
            </button>
        </div>
    </div>

    <!-- Board-Tabelle -->
    <table class="table table-hover align-middle bg-white shadow-sm" style="border-radius: 8px; overflow: hidden;">
        <thead class="table-light">
            <tr>
                <th class="py-3 ps-3">Name des Boards</th>
                <th>Erstellt am</th>
                <th class="text-end pe-3" style="width: 150px;">Aktionen</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var board in Model)
                {
                    <tr>
                        <td class="ps-3">
                            <a asp-action="Details" asp-route-id="@board.Id" class="text-decoration-none text-dark fw-medium">@board.Titel</a>
                        </td>
                        <td class="text-muted small">@board.CreatedAt.ToString("dd.MM.yyyy")</td>
                        <td class="pe-3">
                            <div class="action-buttons">
                                <a asp-action="Details" asp-route-id="@board.Id" class="btn btn-sm btn-outline-secondary"><i class="bi bi-box-arrow-up-right"></i></a>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openEditModal(@board.Id, '@Html.Raw(Html.Encode(board.Titel))')"><i class="bi bi-pencil"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="openDeleteModal(@board.Id, '@Html.Raw(Html.Encode(board.Titel))')"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="3" class="text-center text-muted py-5"><h5>Noch keine Boards vorhanden</h5></td></tr>
            }
        </tbody>
    </table>
</div>

<!-- ========================= MODALS ========================= -->
<!-- Modal: Board Erstellen -->
<div class="modal fade" id="createBoardModal" tabindex="-1" aria-labelledby="createBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-controller="Board" asp-action="Create" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header"><h5 class="modal-title">Neues Board erstellen</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Name des Boards</label><input name="Titel" class="form-control" required></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button><button type="submit" class="btn btn-primary">Board erstellen</button></div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Board Bearbeiten -->
<div class="modal fade" id="editBoardModal" tabindex="-1" aria-labelledby="editBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- WICHTIG: asp-action wurde entfernt, da es durch JS gesetzt wird -->
            <form id="editForm" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="editBoardId" />
                <div class="modal-header"><h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Board bearbeiten</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="editTitel" class="form-label">Name des Boards</label><input name="Titel" id="editTitel" class="form-control" required></div>
                    <div class="mb-3"><label for="editDescription" class="form-label">Beschreibung (optional)</label><textarea name="Description" id="editDescription" class="form-control" rows="3"></textarea></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button><button type="submit" class="btn btn-primary">Änderungen speichern</button></div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Board Löschen -->
<div class="modal fade" id="deleteBoardModal" tabindex="-1" aria-labelledby="deleteBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0"><h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Board löschen</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p>Möchten Sie das Board <strong id="boardNameToDelete"></strong> wirklich löschen?</p>
                <div class="alert alert-warning d-flex align-items-center"><i class="bi bi-exclamation-triangle-fill me-2"></i><small>Diese Aktion ist endgültig.</small></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <form id="deleteForm" method="post">@Html.AntiForgeryToken()<button type="submit" class="btn btn-danger">Endgültig löschen</button></form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openDeleteModal(boardId, boardTitle) {
            var deleteModalEl = document.getElementById('deleteBoardModal');
            if (deleteModalEl) {
                deleteModalEl.querySelector('#boardNameToDelete').textContent = boardTitle;
                deleteModalEl.querySelector('#deleteForm').action = '/Board/Delete/' + boardId;
                var modal = new bootstrap.Modal(deleteModalEl);
                modal.show();
            }
        }

        // ====== KORRIGIERTE FUNKTION ======
        function openEditModal(boardId, boardTitle) {
            var editModalEl = document.getElementById('editBoardModal');
            if (editModalEl) {
                // Finde das Formular innerhalb des Modals
                var form = editModalEl.querySelector('#editForm');

                // 1. Setze die Action-URL des Formulars dynamisch mit der korrekten ID
                form.action = '/Board/Edit/' + boardId;

                // 2. Befülle die Werte der Input-Felder
                form.querySelector('#editTitel').value = boardTitle;
                form.querySelector('#editBoardId').value = boardId;

                // 3. Zeige das Modal an
                var modal = new bootstrap.Modal(editModalEl);
                modal.show();
            }
        }
    </script>
}