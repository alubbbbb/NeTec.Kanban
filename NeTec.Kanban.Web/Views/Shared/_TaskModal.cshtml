<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow border-0">

            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Aufgabe bearbeiten</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="editTaskId" />
                <input type="hidden" id="editTaskColumnId" />

                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold text-muted">TITEL</label>
                        <input id="editTaskTitle" class="form-control fw-bold" placeholder="Titel der Aufgabe" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">PRIORITÄT</label>
                        <select id="editTaskPriority" class="form-select">
                            <option value="Low">Niedrig</option>
                            <option value="Medium">Mittel</option>
                            <option value="High">Hoch</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">ZUSTÄNDIG</label>
                        <select id="editTaskAssignedUser" class="form-select">
                            <option value="">-- Niemand --</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label small fw-bold text-muted">BESCHREIBUNG</label>
                        <textarea id="editTaskDescription" class="form-control" rows="4"></textarea>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">FÄLLIG AM</label>
                        <input type="date" id="editTaskDueDate" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">GEPLANT (H)</label>
                        <input type="number" step="0.5" id="editTaskPlannedTime" class="form-control" placeholder="0.0" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">IST / VERBRAUCHT (H)</label>
                        <input type="number" step="0.5" id="editTaskActualTime" class="form-control" placeholder="0.0" />
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-light text-muted" data-bs-dismiss="modal">Abbrechen</button>
                <button class="btn btn-primary fw-bold px-4" id="saveTaskChanges">Speichern</button>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * Initialisierung der Modal-Logik nach Laden des DOM.
     */
    document.addEventListener("DOMContentLoaded", () => {
        loadUsers();
        setupModalEvents();
    });

    /**
     * Lädt asynchron die Liste der zuweisbaren Benutzer vom Server
     * und befüllt das Dropdown-Menü.
     */
    function loadUsers() {
        fetch('/Task/GetAssignableUsers')
            .then(r => r.json())
            .then(users => {
                const select = document.getElementById("editTaskAssignedUser");
                // Reset der Optionen
                select.innerHTML = '<option value="">-- Niemand --</option>';

                users.forEach(u => {
                    select.innerHTML += `<option value="${u.id}">${u.userName}</option>`;
                });
            });
    }

    /**
     * Registriert Event-Listener für Interaktionen (Öffnen, Speichern).
     * Nutzt Event Delegation für dynamisch erstellte Buttons.
     */
    function setupModalEvents() {
        document.body.addEventListener('click', e => {
            // Fall: "Aufgabe erstellen" Button geklickt
            const btnAdd = e.target.closest('.btn-add-task');
            if (btnAdd) {
                resetModal();
                // Spalten-ID aus dem Button-Attribut übernehmen
                document.getElementById("editTaskColumnId").value = btnAdd.dataset.columnId;
                new bootstrap.Modal(document.getElementById("editTaskModal")).show();
            }

            // Fall: "Bearbeiten" Button geklickt
            const btnEdit = e.target.closest('.btn-edit-task');
            if (btnEdit) {
                loadTaskData(btnEdit.dataset.taskId);
            }
        });

        // Speicher-Button Event
        document.getElementById("saveTaskChanges").addEventListener("click", saveTask);
    }

    /**
     * Setzt alle Formularfelder auf ihren Initialzustand zurück.
     * Wird vor dem Öffnen des Modals im "Erstellen"-Modus aufgerufen.
     */
    function resetModal() {
        document.getElementById("editTaskId").value = "";
        document.getElementById("editTaskTitle").value = "";
        document.getElementById("editTaskDescription").value = "";
        document.getElementById("editTaskPriority").value = "Medium";
        document.getElementById("editTaskDueDate").value = "";
        document.getElementById("editTaskPlannedTime").value = "";
        document.getElementById("editTaskActualTime").value = "";
        document.getElementById("editTaskAssignedUser").value = "";
    }

    /**
     * Ruft die aktuellen Daten einer Aufgabe via API ab und befüllt das Formular.
     * param {number} id - Die ID der zu ladenden Aufgabe.
     */
    function loadTaskData(id) {
        fetch('/Task/GetTask/' + id)
            .then(r => r.json())
            .then(data => {
                // Mapping der API-Daten auf die Formularfelder
                document.getElementById("editTaskId").value = data.id;
                document.getElementById("editTaskColumnId").value = data.columnId;
                document.getElementById("editTaskTitle").value = data.title;
                document.getElementById("editTaskDescription").value = data.description || "";
                document.getElementById("editTaskPriority").value = data.priority || "Medium";
                document.getElementById("editTaskDueDate").value = data.dueDate || "";
                document.getElementById("editTaskPlannedTime").value = data.plannedTime || "";
                document.getElementById("editTaskActualTime").value = data.actualTime || "";
                document.getElementById("editTaskAssignedUser").value = data.assignedUserId || "";

                // Modal anzeigen
                new bootstrap.Modal(document.getElementById("editTaskModal")).show();
            });
    }

    /**
     * Sammelt die Formulardaten und sendet sie an den Server (Create oder Edit).
     */
    function saveTask() {
        const id = document.getElementById("editTaskId").value;

        // Extraktion und Typumwandlung der Formulardaten für das Payload-Objekt
        const payload = {
            id: id ? parseInt(id) : 0,
            columnId: parseInt(document.getElementById("editTaskColumnId").value),
            title: document.getElementById("editTaskTitle").value,
            description: document.getElementById("editTaskDescription").value,
            priority: document.getElementById("editTaskPriority").value,
            dueDate: document.getElementById("editTaskDueDate").value || null,
            plannedTime: parseFloat(document.getElementById("editTaskPlannedTime").value) || null,
            actualTime: parseFloat(document.getElementById("editTaskActualTime").value) || null,
            assignedUserId: document.getElementById("editTaskAssignedUser").value || null
        };

        // Client-seitige Validierung
        if (!payload.title) {
            alert("Bitte geben Sie einen Titel ein.");
            return;
        }

        // Entscheidung ob POST an Create oder EditTask Endpunkt gesendet wird
        const url = id ? '/Task/EditTask' : '/Task/Create';
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        // Senden des Requests
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": token
            },
            body: JSON.stringify(payload)
        }).then(r => {
            if(r.ok) location.reload(); // Seite neu laden bei Erfolg
            else alert("Fehler beim Speichern der Daten.");
        });
    }
</script>